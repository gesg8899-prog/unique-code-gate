<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Player Gate – Auto Sync</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #000000;
  color: #ffd700;
  text-align: center;
  padding: 60px 30px;
}
.gate {
  max-width: 450px;
  margin: auto;
  padding: 30px;
  border-radius: 20px;
  background: linear-gradient(145deg, #1a1a1a, #000);
  border: 2px solid #ffd700;
  box-shadow: 0 0 25px #ffcc00;
}
input {
  width: 80%;
  padding: 12px;
  margin-bottom: 15px;
  border-radius: 10px;
  border: 1px solid #ffd700;
  background: #0d0d0d;
  color: #ffd700;
  font-size: 16px;
}
button {
  padding: 12px 20px;
  border-radius: 10px;
  border: none;
  background: #ffd700;
  color: #000;
  font-weight: bold;
  font-size: 16px;
  cursor: pointer;
}
#errorMsg {
  margin-top: 10px;
  font-weight: bold;
}
.error { color: #ff4040; }
.success { color: #66ff66; }
</style>
</head>
<body>

<div class="gate">
  <h1 style="font-size: 26px; font-weight: 700; margin-bottom: 10px;">Enter Access Code</h1>
  <input type="text" id="codeInput" placeholder="Enter your code">
  <button onclick="validateCode()">Enter</button>
  <p id="errorMsg"></p>
</div>

<script>
// ========================
// CONFIG
// ========================
const rawURL = "https://raw.githubusercontent.com/gesg8899-prog/unique-code-gate/main/player_codes.json";
const githubAPI = "https://api.github.com/repos/gesg8899-prog/unique-code-gate/contents/player_codes.json";
const redirectURL = "https://is.gd/plinko88";

// !!! AMAN: Gunakan token khusus yang hanya punya repo ini
const token = "GITHUB_PERSONAL_ACCESS_TOKEN"; // ganti dengan token admin

// ========================
// LOAD LATEST CODES
// ========================
async function loadCodes() {
  const res = await fetch(rawURL + "?ts=" + Date.now());
  return await res.json();
}

// ========================
// SAVE UPDATED CODES KE GITHUB
// ========================
async function saveToGitHub(codes) {
  // Ambil SHA terbaru
  const fileRes = await fetch(githubAPI, {
    headers: { "Authorization": `Bearer ${token}` }
  });
  const fileData = await fileRes.json();
  const newContent = btoa(JSON.stringify(codes, null, 2));

  const uploadRes = await fetch(githubAPI, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify({
      message: "Mark code as used via Player Gate",
      content: newContent,
      sha: fileData.sha
    })
  });

  return uploadRes.ok;
}

// ========================
// VALIDATE CODE
// ========================
async function validateCode() {
  const msg = document.getElementById("errorMsg");
  msg.textContent = '';
  msg.className = '';

  const codeInput = document.getElementById("codeInput").value.trim().toUpperCase();
  if(!codeInput){
    msg.textContent = "Code cannot be empty";
    msg.className = "error";
    return;
  }

  try {
    let codes = await loadCodes();
    let entry = codes.find(c => c.code === codeInput);

    if(!entry){
      msg.textContent = "Code not found";
      msg.className = "error";
      return;
    }

    if(entry.used){
      msg.textContent = "Code already used";
      msg.className = "error";
      return;
    }

    // Tandai used
    entry.used = true;
    msg.textContent = "✅ Code valid! Updating server...";
    msg.className = "success";

    const ok = await saveToGitHub(codes);

    if(!ok){
      msg.textContent = "Failed to update server";
      msg.className = "error";
      return;
    }

    msg.textContent = "Access Granted. Redirecting...";
    msg.className = "success";
    setTimeout(() => window.location.href = redirectURL, 800);

  } catch(e) {
    console.error(e);
    msg.textContent = "Connection error";
    msg.className = "error";
  }
}
</script>

</body>
</html>
